<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Departamento de Detectives - LSPD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
            color: #e0e0e0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, rgba(33, 150, 243, 0.03) 0px, transparent 1px, transparent 2px, rgba(33, 150, 243, 0.03) 3px);
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.9), rgba(25, 118, 210, 0.8));
            border: 3px solid #1976d2;
            border-radius: 10px;
            margin-bottom: 40px;
            box-shadow: 0 0 40px rgba(25, 118, 210, 0.6), inset 0 0 30px rgba(33, 150, 243, 0.2);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: 'üöî';
            position: absolute;
            font-size: 200px;
            opacity: 0.08;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        h1 {
            font-size: 3em;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(33, 150, 243, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 3px;
            position: relative;
        }

        .subtitle {
            color: #bbdefb;
            margin-top: 10px;
            font-style: italic;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(145deg, #1565c0, #0d47a1);
            color: #ffffff;
            border: 2px solid #1976d2;
            padding: 15px 40px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .nav-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .nav-btn:hover {
            background: linear-gradient(145deg, #1976d2, #1565c0);
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.6);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(145deg, #2196f3, #1976d2);
            color: #ffffff;
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.8), inset 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: linear-gradient(145deg, rgba(13, 71, 161, 0.3), rgba(10, 25, 41, 0.8));
            border: 2px solid #1976d2;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6), 0 0 20px rgba(25, 118, 210, 0.2);
            transition: all 0.3s;
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #1976d2, #2196f3, #1976d2);
            border-radius: 10px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
        }

        .card:hover::before {
            opacity: 0.4;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(33, 150, 243, 0.5);
        }

        h2 {
            color: #2196f3;
            border-bottom: 3px solid #1976d2;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 2em;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, #1976d2, #1565c0);
            color: #ffffff;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
        }

        .btn:hover {
            background: linear-gradient(145deg, #2196f3, #1976d2);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.6);
        }

        .report-item {
            background: rgba(13, 71, 161, 0.15);
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #1976d2;
            border-radius: 5px;
            transition: all 0.3s;
            position: relative;
        }

        .report-item:hover {
            background: rgba(33, 150, 243, 0.2);
            border-left-width: 8px;
            padding-left: 24px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status.cerrado {
            background: #5c1a1a;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        .status.abierto {
            background: #2d5016;
            color: #8bc34a;
            border: 1px solid #8bc34a;
        }

        .status.investigando {
            background: #3d3d00;
            color: #ffd700;
            border: 1px solid #ffd700;
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: linear-gradient(145deg, rgba(13, 71, 161, 0.95), rgba(10, 25, 41, 0.98));
            border: 3px solid #1976d2;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(25, 118, 210, 0.7);
            margin: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2196f3;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(13, 71, 161, 0.2);
            border: 2px solid #1976d2;
            border-radius: 5px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
            background: rgba(13, 71, 161, 0.3);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
            margin: 0;
        }

        .btn-danger {
            background: #ff6b6b;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn-edit {
            background: #4a90e2;
        }

        .btn-edit:hover {
            background: #357abd;
        }

        .btn-success {
            background: #4caf50;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .json-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .json-controls .btn {
            flex: 1;
            min-width: 200px;
        }

        input[type="file"] {
            display: none;
        }

        .case-card {
            background: rgba(13, 71, 161, 0.2);
            border: 2px solid #1976d2;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .case-card:hover {
            background: rgba(33, 150, 243, 0.25);
            border-color: #2196f3;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .case-number {
            color: #2196f3;
            font-weight: bold;
            font-size: 1.2em;
        }

        .case-type {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .case-type.informe {
            background: rgba(33, 150, 243, 0.3);
            color: #64b5f6;
            border: 1px solid #64b5f6;
        }

        .case-type.multa {
            background: rgba(233, 30, 99, 0.3);
            color: #f06292;
            border: 1px solid #f06292;
        }

        /* Estilos de la Tablet Policial */
        .tablet {
            width: 100%;
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(139, 92, 246, 0.1);
        }

        .tablet-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.2);
            flex-wrap: wrap;
        }

        .tab-button {
            background: rgba(139, 92, 246, 0.1);
            color: #a78bfa;
            border: 2px solid rgba(139, 92, 246, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: #fff;
            border-color: #8b5cf6;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .tab-button:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        .close-icon {
            margin-left: 5px;
            opacity: 0.6;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-icon:hover {
            opacity: 1;
            background: rgba(220, 60, 60, 0.3);
        }

        .add-tab-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: #fff;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .add-tab-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }

        .tablet-content {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            min-height: 600px;
            position: relative;
        }

        .tab-panel {
            display: none;
            height: 100%;
            opacity: 0;
            animation: fadeIn 0.4s ease forwards;
        }

        .tab-panel.active {
            display: block;
        }

        .home-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 600px;
            padding: 40px;
            text-align: center;
        }

        .home-logo {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .home-title {
            color: #fff;
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        .home-subtitle {
            color: #999;
            font-size: 16px;
            margin-bottom: 50px;
            letter-spacing: 1px;
        }

        .home-buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .home-btn {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(124, 58, 237, 0.2) 100%);
            border: 2px solid rgba(139, 92, 246, 0.4);
            color: #fff;
            padding: 20px 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 200px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .home-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4) 0%, rgba(124, 58, 237, 0.4) 100%);
            border-color: rgba(139, 92, 246, 0.8);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(139, 92, 246, 0.4);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(139, 92, 246, 0.3);
        }

        .modal-title {
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-option {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            border: 2px solid rgba(139, 92, 246, 0.3);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
        }

        .modal-option:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(124, 58, 237, 0.3) 100%);
            border-color: rgba(139, 92, 246, 0.6);
            transform: translateX(5px);
        }

        .modal-cancel {
            background: rgba(220, 60, 60, 0.1);
            border-color: rgba(255, 100, 100, 0.3);
            margin-top: 10px;
        }

        .modal-cancel:hover {
            background: rgba(220, 60, 60, 0.2);
        }

        .criminal-code-view {
            padding: 30px;
            min-height: 600px;
        }

        .code-header {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid rgba(139, 92, 246, 0.2);
        }

        .code-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: 2px;
        }

        .code-json-buttons {
            display: flex;
            gap: 10px;
        }

        .code-json-btn {
            background: transparent;
            border: 2px solid #5b21b6;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #5b21b6;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .code-json-btn:hover {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-color: #8b5cf6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .search-bar {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 92, 246, 0.2);
        }

        .search-bar input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-style: italic;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .code-table-container {
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 92, 246, 0.2);
        }

        .code-table {
            width: 100%;
            border-collapse: collapse;
        }

        .code-table thead {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(124, 58, 237, 0.3) 100%);
        }

        .code-table th {
            padding: 15px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        .code-table tbody tr {
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            transition: all 0.3s ease;
        }

        .code-table tbody tr:hover {
            background: rgba(139, 92, 246, 0.15);
            transform: scale(1.01);
        }

        .code-table td {
            padding: 15px;
            color: #ddd;
            font-size: 13px;
        }

        .section-header {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            padding: 12px 15px;
            font-weight: 700;
            color: #fff;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .article-number {
            color: #c4b5fd;
            font-weight: 600;
            font-style: italic;
        }

        .eliminate-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
            margin-right: 5px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .eliminate-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        .edit-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
            margin-right: 5px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .edit-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.5);
        }

        .move-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .move-btn:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: scale(1.1);
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .action-btns-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .section-header-row {
            position: relative;
        }

        .edit-chapter-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        }

        .edit-chapter-btn:hover {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.5);
        }

        .add-code-view {
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
        }

        .form-title {
            color: #fff;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 16px;
            font-style: italic;
        }

        .rank-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .rank-card:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateX(5px);
        }

        .rank-info {
            flex: 1;
        }

        .rank-name {
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .rank-salary {
            color: #10b981;
            font-size: 24px;
            font-weight: 700;
        }

        .rank-actions {
            display: flex;
            gap: 10px;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .edit-form-group {
            margin-bottom: 25px;
        }

        .edit-form-group label {
            display: block;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .edit-form-group input,
        .edit-form-group textarea,
        .edit-form-group select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 12px 15px;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }

        .edit-form-group input:focus,
        .edit-form-group textarea:focus,
        .edit-form-group select:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.8);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .edit-form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .edit-modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .edit-modal-btn.save {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .edit-modal-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
        }

        .edit-modal-btn.cancel {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .edit-modal-btn.cancel:hover {
            background: rgba(220, 60, 60, 0.2);
            border-color: rgba(255, 100, 100, 0.5);
        }

        .edit-modal-title {
            color: #fff;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
            }
            
            .json-controls {
                flex-direction: column;
            }
            
            .case-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .tablet-header {
                flex-wrap: wrap;
            }
            
            .code-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .code-json-buttons {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .home-buttons {
                flex-direction: column;
            }

            .home-btn {
                width: 100%;
            }

            .rank-card {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>

    <!-- LOGIN ESTILIZADO -->
    <div id="loginScreen" style="
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        background: #0a0f2b;
        display:flex; justify-content:center; align-items:center;
        z-index:9999;
        font-family: 'Courier New', monospace;
        ">
        <div style="
            background: rgba(30,60,120,0.95);
            border: 2px solid #2a5cff;
            border-radius: 12px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
            min-width: 320px;
            max-width: 400px;
            color: #fff;
        ">
            <div style="font-size: 32px; font-weight:bold; color:#2a5cff; margin-bottom:20px;">
                üîí ACCESO AL SISTEMA
            </div>
            <div style="height:2px; background:#2a5cff; width:60px; margin:0 auto 20px;"></div>
            <input id="passwordInput" type="password" placeholder="Contrase√±a" style="
                width:100%; padding:12px; font-size:16px;
                border-radius:6px; border:1px solid #2a5cff;
                background:#0a1a4b; color:#fff; outline:none; margin-bottom:20px;
            ">
            <button onclick="checkPassword()" style="
                width:100%; padding:12px;
                background:#2a5cff; color:white; font-size:16px;
                border:none; border-radius:6px; cursor:pointer;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='#1a45ff'" onmouseout="this.style.background='#2a5cff'">
                ACCEDER
            </button>
            <p id="loginError" style="color:#ff6b6b; margin-top:12px; display:none;">Contrase√±a incorrecta</p>
            <p style="color:#99cfff; font-size:12px; margin-top:10px;">
            </p>
        </div>
    </div>


        <header>
            <h1>üöî DEPARTAMENTO DE DETECTIVES üöî</h1>
            <p class="subtitle">Los Santos Police Department - Sistema Integrado</p>
            <button id="logoutBtn" style="
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(220, 60, 60, 0.8);
                color: white;
                border: 2px solid #ff6b6b;
                padding: 10px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
                font-weight: bold;
                transition: all 0.3s;
            " onmouseover="this.style.background='rgba(220, 60, 60, 1)'" 
               onmouseout="this.style.background='rgba(220, 60, 60, 0.8)'">
                üîì CERRAR SESI√ìN
            </button>
        </header>

        <div class="nav-buttons">
            <button class="nav-btn active detective-only" onclick="showSection('informes')">üìã Informes</button>
            <button class="nav-btn detective-only abogado-only" onclick="showSection('historial')">üìö Historial de Casos</button>
            <button class="nav-btn detective-only abogado-only" onclick="showSection('tablet')">üíª Tablet Policial</button>
        </div>

        <!-- SECCI√ìN INFORMES -->
        <div class="section active" id="informes">
            <div class="card">
                <h2>üìã Informes de Detectives</h2>
                

                <button class="btn" onclick="openReportModal()">‚ûï A√±adir Nuevo Informe</button>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 10px; border: 2px solid #1976d2;">
                        <div id="statCasosCerrados" style="font-size: 3em; color: #2196f3;">0</div>
                        <div>Casos Cerrados</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 10px; border: 2px solid #1976d2;">
                        <div id="statCasosAbiertos" style="font-size: 3em; color: #2196f3;">0</div>
                        <div>Casos Abiertos</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 10px; border: 2px solid #1976d2;">
                        <div id="statCasosInvestigando" style="font-size: 3em; color: #2196f3;">0</div>
                        <div>En Investigaci√≥n</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 10px; border: 2px solid #1976d2;">
                        <div id="statMultas" style="font-size: 3em; color: #2196f3;">0</div>
                        <div>Multas Registradas</div>
                    </div>
                </div>

                <div id="reportsList"></div>
            </div>
        </div>

        <!-- SECCI√ìN HISTORIAL -->
        <div class="section" id="historial">
            <div class="card">
                <h2>üìö Historial Completo de Casos</h2>
                
                <div class="form-group">
                    <label>Buscar por n√∫mero de caso, nombre, ID o detective</label>
                    <input type="text" id="searchHistorial" placeholder="Buscar..." onkeyup="filterHistorial()">
                </div>

                <div id="historialList"></div>
            </div>
        </div>

        <!-- SECCI√ìN TABLET -->
        <div class="section" id="tablet">
            <div class="card">
                <h2>üíª Tablet Policial - C√≥digo Criminal y Multas</h2>
                <p style="color: #90caf9; margin-bottom: 20px;">Sistema integrado de gesti√≥n de c√≥digo criminal, multas y rangos</p>
                
                <div class="tablet">
                    <div class="tablet-header" id="tabletHeader">
                        <button class="add-tab-btn" id="addTabBtn" onclick="document.getElementById('modalOverlay').classList.add('active')">+</button>
                    </div>

                    <div class="tablet-content">
                        <div class="tab-panel active" id="home">
                            <div class="home-screen">
                                <div class="home-logo">üöî</div>
                                <h1 class="home-title">C√ìDIGO CRIMINAL</h1>
                                <p class="home-subtitle">Sistema de Gesti√≥n Policial</p>
                                <div class="home-buttons">
                                    <button class="home-btn detective-only" onclick="openTab('multas', 'MULTAS')">
                                     üí∞ MULTAS
                                    </button>
                                    <button class="home-btn admin-only abogado-only" onclick="openTab('codigo', 'C. CRIMINAL')">
                                        üìñ Ver C√≥digo Criminal
                                    </button>
                                    <button class="home-btn admin-only" onclick="openTab('a√±adir', 'A√ëADIR C√ìDIGO')">
                                        ‚ûï A√±adir Art√≠culo
                                    </button>
                                    <button class="home-btn admin-only" onclick="openTab('categorias', 'GESTIONAR CATEGOR√çAS')">
                                        üìã Gestionar Categor√≠as
                                    </button>
                                    <button class="home-btn admin-only" onclick="openTab('rangos', 'RANGOS POLICIALES')">
                                        üéñÔ∏è Rangos Policiales
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-panel" id="codigo">
                            <div class="criminal-code-view">
                                <div class="code-header">
                                    <h1 class="code-title">C√ìDIGO CRIMINAL</h1>
                                    <div class="code-json-buttons">
                                        <button class="code-json-btn admin-only" onclick="downloadJSON()">
                                            üì• Descargar JSON
                                        </button>
                                        <label for="fileInputCode" class="code-json-btn admin-only" style="margin: 0; cursor: pointer;">
                                            üì§ Cargar JSON
                                        </label>
                                        <input type="file" id="fileInputCode" accept=".json" onchange="loadJSON(event)" style="display: none;">
                                    </div>
                                </div>

                                <div class="search-bar">
                                    <input type="text" id="searchCode" placeholder="Buscar en el c√≥digo criminal..." onkeyup="searchInCode()">
                                </div>

                                <div class="code-table-container">
                                    <table class="code-table">
                                        <thead>
                                            <tr>
                                                <th>ART√çCULO</th>
                                                <th>DESCRIPCI√ìN</th>
                                                <th>CANTIDAD</th>
                                                <th>SENTENCIA</th>
                                                <th>ACCIONES</th>
                                            </tr>
                                        </thead>
                                        <tbody id="codeTableBody">
                                            <tr>
                                                <td colspan="5" class="no-data">No hay art√≠culos registrados. Ve a "A√ëADIR C√ìDIGO" para comenzar.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="tab-panel" id="a√±adir">
                            <div class="add-code-view" style="padding:20px; margin:0 auto; max-width:1200px;">
                                <h2 class="form-title">‚öñÔ∏è A√±adir Nuevo Art√≠culo</h2>
                                
                                <form id="addCodeForm" onsubmit="addArticle(event)">
                                    <div class="form-group">
                                        <label>Cap√≠tulo / Secci√≥n *</label>
                                        <select id="capitulo" required style="width: 100%; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); padding: 12px 15px; border-radius: 8px; color: #fff; font-size: 14px;">
                                            <option value="" disabled selected style="background: #1a1f2e;">Selecciona una categor√≠a...</option>
                                        </select>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Art√≠culo *</label>
                                            <input type="text" id="articulo" required placeholder="Ej: 1.01">
                                        </div>
                                        <div class="form-group">
                                            <label>Cantidad ($) *</label>
                                            <input type="number" id="cantidad" required placeholder="Ej: 100">
                                        </div>
                                        <div class="form-group">
                                            <label>Sentencia (Meses) *</label>
                                            <input type="number" id="sentencia" required placeholder="Ej: 0">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Descripci√≥n *</label>
                                        <textarea id="descripcion" required placeholder="Describe el delito o infracci√≥n..."></textarea>
                                    </div>

                                    <button type="submit" class="submit-btn" id="submitBtn">‚úì A√±adir Art√≠culo al C√≥digo</button>
                                </form>
                            </div>
                        </div>

                        <div class="tab-panel" id="categorias">
                            <div class="add-code-view" style="padding:20px; margin:0 auto; max-width:1200px;">
                                <h2 class="form-title">üìã Gestionar Categor√≠as</h2>
                                
                                <div class="form-group">
                                    <label>Nueva Categor√≠a</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="newCategoryInput" placeholder="Ej: 1. DELITOS CONTRA LA SEGURIDAD VIAL" style="flex: 1; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); padding: 12px 15px; border-radius: 8px; color: #fff; font-size: 14px;">
                                        <button type="button" onclick="addCategory()" style="background: rgb(46, 204, 113); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap;">
                                            ‚ûï A√±adir
                                        </button>
                                    </div>
                                </div>

                                <div style="margin-top: 30px;">
                                    <h3 style="color: #fff; font-size: 18px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">üìã Categor√≠as Existentes</h3>
                                    <div id="categoriesList" style="display: flex; flex-direction: column; gap: 10px;">
                                        <p style="color: #999; text-align: center; padding: 40px; font-style: italic;">No hay categor√≠as. A√±ade la primera.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-panel" id="rangos">
                            <div class="add-code-view" style="padding:20px; margin:0 auto; max-width:1200px;">
                                <h2 class="form-title">üéñÔ∏è Rangos Policiales</h2>
                                
                                <div class="form-group">
                                    <label>A√±adir Nuevo Rango</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="newRankName" placeholder="Nombre del rango (Ej: Cadete)" style="flex: 2; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); padding: 12px 15px; border-radius: 8px; color: #fff; font-size: 14px;">
                                        <input type="number" id="newRankSalary" placeholder="Salario en $" min="0" style="flex: 1; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); padding: 12px 15px; border-radius: 8px; color: #fff; font-size: 14px;">
                                        <button type="button" onclick="addRank()" style="background: rgb(46, 204, 113); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap;">
                                            ‚ûï A√±adir
                                        </button>
                                    </div>
                                </div>

                                <div style="margin-top: 30px;">
                                    <h3 style="color: #fff; font-size: 18px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">üéñÔ∏è Rangos Actuales</h3>
                                    <div id="ranksList">
                                        <p class="no-data">No hay rangos a√±adidos. A√±ade el primero.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-panel" id="multas" style="padding:0; margin:0;">
                            <div class="add-code-view" style="padding:20px; margin:0 auto; max-width:1200px;">
                                <h2 class="form-title">üí∞ GESTOR DE MULTAS</h2>

                                <div class="form-group">
                                    <label>Nombre y apellido del sancionado *</label>
                                    <input type="text" id="nombreMultado" placeholder="Ej: Juan P√©rez" style="width:100%; background: rgba(255, 255, 255, 0.05); border:2px solid rgba(255,255,255,0.08); padding:12px 15px; border-radius:8px; color:#fff;">
                                </div>

                                <div class="form-group">
                                    <label>ID del sancionado *</label>
                                    <input type="text" id="idMultado" placeholder="Ej: 12345" style="width:100%; background: rgba(255, 255, 255, 0.05); border:2px solid rgba(255,255,255,0.08); padding:12px 15px; border-radius:8px; color:#fff;">
                                </div>

                                <div class="form-group">
                                    <label>Buscar art√≠culos del C√≥digo Criminal</label>
                                    <div style="display:flex; gap:10px;">
                                        <input type="text" id="buscarArticulo" placeholder="Buscar por art√≠culo o descripci√≥n..." style="flex:1; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.08); background: rgba(255, 255, 255, 0.05); color:#fff;">
                                        <button type="button" onclick="mostrarArticulosMulta()" style="background: rgb(46, 204, 113); color:#fff; border:none; padding:10px 18px; border-radius:8px; font-weight:700;">Mostrar</button>
                                    </div>
                                </div>

                                <div class="multa-seccion" style="margin-top:15px;">
                                    <h3 style="color:#fff; margin-bottom:10px;">Art√≠culos disponibles</h3>
                                    <div style="max-height:220px; overflow:auto; border-radius:10px; background: rgba(255, 255, 255, 0.03); padding:8px;">
                                        <table class="code-table" style="width:100%;">
                                            <thead>
                                                <tr>
                                                    <th>ART√çCULO</th>
                                                    <th>DESCRIPCI√ìN</th>
                                                    <th>CANTIDAD</th>
                                                    <th>SENTENCIA</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="articulosMultaBody">
                                                <tr><td colspan="5" class="no-data">Pulsa "Mostrar" para listar art√≠culos.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="multa-seccion" style="margin-top:15px;">
                                    <h3 style="color:#fff; margin-bottom:10px;">Multa actual</h3>
                                    <div style="max-height:220px; overflow:auto; border-radius:10px; background: rgba(255, 255, 255, 0.03); padding:8px;">
                                        <table class="code-table" style="width:100%;">
                                            <thead>
                                                <tr>
                                                    <th>ART√çCULO</th>
                                                    <th>DESCRIPCI√ìN</th>
                                                    <th>CANTIDAD</th>
                                                    <th>SENTENCIA</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="multaActualBody">
                                                <tr><td colspan="5" class="no-data">No hay art√≠culos en la multa actual.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div style="display:flex; gap:15px; align-items:center; margin-top:15px;">
                                    <div style="flex:1; color:#fff;">
                                        <p><strong>Total cantidad:</strong> <span id="totalCantidad">0</span> $</p>
                                        <p><strong>Total sentencia:</strong> <span id="totalSentencia">0</span> meses</p>
                                    </div>
                                    <div style="width:240px; display:flex; flex-direction:column; gap:8px;">
                                        <button type="button" onclick="confirmarMulta()" style="background: rgb(46, 204, 113); color:#fff; border:none; padding:12px 10px; border-radius:8px; font-weight:700;">‚úÖ Confirmar multa</button>
                                        <button type="button" onclick="limpiarMultaActual()" style="background: rgba(255, 255, 255, 0.05); color:#fff; border:2px solid rgba(255,255,255,0.08); padding:10px; border-radius:8px;">üóëÔ∏è Limpiar multa</button>
                                    </div>
                                </div>

                                <div style="margin-top:20px;">
                                    <h3 style="color:#fff; margin-bottom:10px;">Historial de multas</h3>
                                    <div id="historialMultas" style="max-height:220px; overflow:auto; background: rgba(255, 255, 255, 0.03); padding:10px; border-radius:8px;">
                                        <p class="no-data" style="color:#999;">No hay multas guardadas.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL A√ëADIR/EDITAR INFORME -->
    <div class="edit-modal" id="reportModal">
        <div class="edit-modal-content">
            <h2 style="color: #2196f3; text-align: center; margin-bottom: 20px;" id="modalTitle">üìù Nuevo Informe de Detective</h2>
            
            <div class="form-group">
                <label>N√∫mero de Caso *</label>
                <input type="text" id="caseNumber" placeholder="Ej: CASO #2024-1001">
            </div>

            <div class="form-group">
                <label>Estado *</label>
                <select id="caseStatus">
                    <option value="abierto">Abierto</option>
                    <option value="cerrado">Cerrado</option>
                    <option value="investigando">En Investigaci√≥n</option>
                </select>
            </div>

            <div class="form-group">
                <label>T√≠tulo *</label>
                <input type="text" id="caseTitle" placeholder="T√≠tulo del caso">
            </div>

            <div class="form-group">
                <label>Detective Asignado *</label>
                <input type="text" id="caseDetective" placeholder="Ej: Det. Ram√≠rez">
            </div>

            <div class="form-group">
                <label>Fecha *</label>
                <input type="text" id="caseDate" placeholder="Ej: 15/09/2024">
            </div>

            <div class="form-group">
                <label>Resumen *</label>
                <textarea id="caseSummary" placeholder="Descripci√≥n detallada del caso"></textarea>
            </div>

            <h3 style="color: #64b5f6; margin: 20px 0;">üßæ Informaci√≥n del Sospechoso</h3>

            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" id="suspectName" placeholder="Nombre y apellido">
            </div>

            <div class="form-group">
                <label>DNI</label>
                <input type="text" id="suspectDNI" placeholder="Documento">
            </div>

            <div class="form-group">
                <label>Descripci√≥n F√≠sica</label>
                <textarea id="suspectDescription" placeholder="Detalles f√≠sicos del sospechoso"></textarea>
            </div>

            <h3 style="color: #64b5f6; margin: 20px 0;">üí∞ Multas Asociadas</h3>
            <p style="color: #90caf9; font-size: 0.9em; margin-bottom: 10px;">Las multas creadas desde la Tablet aparecer√°n autom√°ticamente vinculadas si tienen el mismo nombre/ID</p>
            
            <div id="associatedFinesDisplay"></div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn" onclick="closeReportModal()" style="background: #5a5a5a;">‚ùå Cancelar</button>
                <button class="btn" onclick="saveReport()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL SELECCI√ìN DE PESTA√ëA TABLET -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <h3 class="modal-title">Seleccionar Pesta√±a</h3>
            <div class="modal-options">
                <div class="modal-option detective-only" onclick="openTab('multas', 'MULTAS')">
                    üí∞ Multas
                </div>
                <div class="modal-option admin-only abogado-only" onclick="openTab('codigo', 'C. CRIMINAL')">
                    üìñ C√≥digo Criminal
                </div>
                <div class="modal-option admin-only" onclick="openTab('a√±adir', 'A√ëADIR C√ìDIGO')">
                    ‚ûï A√±adir C√≥digo
                </div>
                <div class="modal-option admin-only" onclick="openTab('categorias', 'GESTIONAR CATEGOR√çAS')">
                    üìã Gestionar Categor√≠as
                </div>
                <div class="modal-option admin-only" onclick="openTab('rangos', 'RANGOS POLICIALES')">
                    üéñÔ∏è Rangos Policiales
                </div>
                <div class="modal-option modal-cancel" onclick="closeModal()">
                    ‚úï Cancelar
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR ART√çCULO TABLET -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <h2 class="edit-modal-title">
                <span>‚úèÔ∏è</span> Editar Art√≠culo
            </h2>
            
            <div class="edit-form-group">
                <label>Cap√≠tulo / Secci√≥n *</label>
                <select id="editCapituloInput" required style="width: 100%; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); padding: 12px 15px; border-radius: 8px; color: #fff; font-size: 14px;">
                    <option value="" disabled style="background: #1a1f2e;">Selecciona una categor√≠a...</option>
                </select>
            </div>

            <div class="edit-form-row">
                <div class="edit-form-group">
                    <label>Art√≠culo *</label>
                    <input type="text" id="editArticuloInput" required placeholder="Ej: 1.01">
                </div>
                <div class="edit-form-group">
                    <label>Cantidad ($) *</label>
                    <input type="number" id="editCantidadInput" required placeholder="100">
                </div>
            </div>

            <div class="edit-form-group">
                <label>Sentencia (Meses) *</label>
                <input type="number" id="editSentenciaInput" required placeholder="0">
            </div>

            <div class="edit-form-group">
                <label>Descripci√≥n *</label>
                <textarea id="editDescripcionInput" required placeholder="Describe el delito o infracci√≥n..."></textarea>
            </div>

            <div class="edit-modal-buttons">
                <button class="edit-modal-btn cancel" onclick="closeEditModal()">
                    ‚úï Cancelar
                </button>
                <button class="edit-modal-btn save" onclick="saveEditedArticle()">
                    ‚úì Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <script>

        // Variables globales
        let reports = [];
        let editingIndex = null;

        // Datos compartidos con la tablet
        let articles = [];
        let openTabs = [];
        let currentEditingArticle = null;
        let categories = [];
        let multas = [];
        let multaActual = [];
        let ranks = [];

        // Flag para saber si ya cargamos los datos de Firestore
        let dataLoaded = false;

        // ==================== FUNCIONES DE FIRESTORE ====================
        async function loadDataFromFirestore() {
            if (!window.db) {
                console.error('Firebase no est√° inicializado');
                return;
            }
        
            try {
                // Cargar reports
                const reportsSnapshot = await window.db.collection('reports').get();
                reports = reportsSnapshot.docs.map(doc => ({
                    firestoreId: doc.id,
                    ...doc.data()
                }));
            
                // Cargar multas
                const multasSnapshot = await window.db.collection('multas').get();
                multas = multasSnapshot.docs.map(doc => ({
                    firestoreId: doc.id,
                    ...doc.data()
                }));
            
                // Cargar articles
                const articlesSnapshot = await window.db.collection('articles').get();
                articles = articlesSnapshot.docs.map(doc => ({
                    firestoreId: doc.id,
                    ...doc.data()
                }));
            
                // Cargar categories
                const categoriesSnapshot = await window.db.collection('categories').get();
                categories = categoriesSnapshot.docs.map(doc => doc.data().name);
            
                // Cargar ranks
                const ranksSnapshot = await window.db.collection('ranks').get();
                ranks = ranksSnapshot.docs.map(doc => ({
                    firestoreId: doc.id,
                    ...doc.data()
                }));
            
                dataLoaded = true;
            
                // Renderizar todo despu√©s de cargar
                renderReports();
                renderHistorial();
                updateStats();
                renderTable(articles);
                renderCategories();
                updateCategoryDropdowns();
                renderHistorialMultas();
                renderRanks();
            
                console.log('‚úÖ Datos cargados desde Firestore (compat)');
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                alert('Error al cargar los datos de la base de datos');
            }
        }


        // ==================== FUNCIONES DE INFORMES ====================
        function openReportModal() {
            editingIndex = null;
            document.getElementById('modalTitle').textContent = 'üìù Nuevo Informe de Detective';
            document.getElementById('caseNumber').value = '';
            document.getElementById('caseStatus').value = 'abierto';
            document.getElementById('caseTitle').value = '';
            document.getElementById('caseDetective').value = '';
            document.getElementById('caseDate').value = '';
            document.getElementById('caseSummary').value = '';
            document.getElementById('suspectName').value = '';
            document.getElementById('suspectDNI').value = '';
            document.getElementById('suspectDescription').value = '';
            updateAssociatedFines();
            document.getElementById('reportModal').classList.add('active');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
            editingIndex = null;
        }

        function updateAssociatedFines() {
            const suspectName = document.getElementById('suspectName').value.trim();
            const suspectDNI = document.getElementById('suspectDNI').value.trim();
            const display = document.getElementById('associatedFinesDisplay');
            
            const relatedFines = multas.filter(m => 
                (suspectName && m.nombre && m.nombre.toLowerCase().includes(suspectName.toLowerCase())) ||
                (suspectDNI && m.idSancionado && m.idSancionado === suspectDNI)
            );

            if (relatedFines.length === 0) {
                display.innerHTML = '<p style="color: #999; font-style: italic;">No hay multas vinculadas a√∫n</p>';
            } else {
                display.innerHTML = relatedFines.map(m => `
                    <div style="background: rgba(33, 150, 243, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 3px solid #2196f3;">
                        <strong style="color: #2196f3;">${m.nombre}</strong> (ID: ${m.idSancionado})
                        <div style="color: #90caf9; font-size: 0.9em; margin-top: 5px;">
                            Total: $${m.totalCantidad.toLocaleString('es-ES')} | ${m.totalSentencia} meses
                        </div>
                    </div>
                `).join('');
            }
        }

        document.getElementById('suspectName')?.addEventListener('input', updateAssociatedFines);
        document.getElementById('suspectDNI')?.addEventListener('input', updateAssociatedFines);

        async function saveReport() {
            const { collection, addDoc, doc, updateDoc } = window.firestoreModules;

            const report = {
                id: Date.now(),
                type: 'informe',
                number: document.getElementById('caseNumber').value,
                status: document.getElementById('caseStatus').value,
                title: document.getElementById('caseTitle').value,
                detective: document.getElementById('caseDetective').value,
                date: document.getElementById('caseDate').value,
                summary: document.getElementById('caseSummary').value,
                suspect: {
                    name: document.getElementById('suspectName').value,
                    dni: document.getElementById('suspectDNI').value,
                    description: document.getElementById('suspectDescription').value
                }
            };
        
            if (!report.number || !report.title || !report.detective || !report.date || !report.summary) {
                alert('‚ùå Por favor completa todos los campos obligatorios');
                return;
            }
        
            try {
                if (editingIndex !== null) {
                    // Actualizar en Firestore
                    const reportToUpdate = reports[editingIndex];
                    await updateDoc(doc(window.db, 'reports', reportToUpdate.firestoreId), report);
                    reports[editingIndex] = { ...report, firestoreId: reportToUpdate.firestoreId };
                    alert('‚úÖ Informe actualizado');
                } else {
                    // A√±adir a Firestore
                    const docRef = await addDoc(collection(window.db, 'reports'), report);
                    reports.unshift({ ...report, firestoreId: docRef.id });
                    alert('‚úÖ Informe a√±adido correctamente');
                }
            
                closeReportModal();
                renderReports();
                updateStats();
            } catch (error) {
                console.error('Error guardando informe:', error);
                alert('‚ùå Error al guardar el informe');
            }
        }

        function renderReports() {
            const container = document.getElementById('reportsList');
            if (!container) return;

            if (reports.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px; font-style: italic;">No hay informes registrados</p>';
                return;
            }

            container.innerHTML = reports.map((report, index) => `
                <div class="report-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <span style="color: #2196f3; font-weight: bold; font-size: 1.1em;">${report.number}</span>
                        <span class="status ${report.status}">${getStatusText(report.status)}</span>
                    </div>
                    <h3 style="color: #64b5f6; margin: 10px 0;">${report.title}</h3>
                    <p style="color: #ddd;"><strong>Detective:</strong> ${report.detective}</p>
                    <p style="color: #ddd;"><strong>Fecha:</strong> ${report.date}</p>
                    <p style="color: #ddd; margin-top: 10px;"><strong>Resumen:</strong> ${report.summary}</p>
                    ${report.suspect && report.suspect.name ? `
                        <p style="color: #90caf9; margin-top: 10px;"><strong>Sospechoso:</strong> ${report.suspect.name}</p>
                    ` : ''}
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-small btn-edit" onclick="editReport(${index})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-small btn-danger" onclick="deleteReport(${index})">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function editReport(index) {
            editingIndex = index;
            const report = reports[index];
            
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Editar Informe';
            document.getElementById('caseNumber').value = report.number;
            document.getElementById('caseStatus').value = report.status;
            document.getElementById('caseTitle').value = report.title;
            document.getElementById('caseDetective').value = report.detective;
            document.getElementById('caseDate').value = report.date;
            document.getElementById('caseSummary').value = report.summary;
            
            if (report.suspect) {
                document.getElementById('suspectName').value = report.suspect.name || '';
                document.getElementById('suspectDNI').value = report.suspect.dni || '';
                document.getElementById('suspectDescription').value = report.suspect.description || '';
            }
            
            updateAssociatedFines();
            document.getElementById('reportModal').classList.add('active');
        }

        async function deleteReport(index) {
            if (!confirm('¬øEst√°s seguro de eliminar este informe?')) return;

            const { doc, deleteDoc } = window.firestoreModules;

            try {
                const report = reports[index];
                await deleteDoc(doc(window.db, 'reports', report.firestoreId));
                reports.splice(index, 1);
                renderReports();
                updateStats();
                alert('‚úÖ Informe eliminado');
            } catch (error) {
                console.error('Error eliminando informe:', error);
                alert('‚ùå Error al eliminar el informe');
            }
        }

        function getStatusText(status) {
            const texts = {
                'abierto': 'ABIERTO',
                'cerrado': 'CERRADO',
                'investigando': 'EN INVESTIGACI√ìN'
            };
            return texts[status] || status;
        }

        function agruparMultas(multas) {
    const grupos = {};

    multas.forEach(m => {
        const key =
            m.nombre.trim().toLowerCase() +
            "_" +
            String(m.idSancionado);

        if (!grupos[key]) {
            grupos[key] = {
                id: m.id,
                type: 'multa',
                number: 'MULTA #' + m.id,
                title: 'Multa a ' + m.nombre,
                date: new Date(m.fecha).toLocaleDateString(),
                nombre: m.nombre,
                idSancionado: m.idSancionado,
                totalCantidad: m.totalCantidad,
                totalSentencia: m.totalSentencia,
                articulos: [...m.articulos]
            };
        } else {
            grupos[key].totalCantidad += m.totalCantidad;
            grupos[key].totalSentencia += m.totalSentencia;
            grupos[key].articulos.push(...m.articulos);
        }
    });

    return Object.values(grupos);
}

        // 1) Agrupa multas por nombre + idSancionado (normalizado)
        function agruparMultas(multas) {
            const grupos = {};
        
            multas.forEach(m => {
                // normalizamos nombre e idSancionado para evitar diferencias por may√∫sculas/espacios/tipos
                const nombreNorm = (m.nombre || '').trim().toLowerCase();
                const idNorm = String(m.idSancionado || '').trim();
                const key = `${nombreNorm}_${idNorm}`;
            
                if (!grupos[key]) {
                    grupos[key] = {
                        // usamos el primer id/fecha/nombre que aparezca; puedes ajustar si prefieres otro criterio
                        id: m.id,
                        type: 'multa',
                        number: 'MULTA #' + m.id,
                        title: 'Multa a ' + m.nombre,
                        date: new Date(m.fecha).toLocaleDateString(),
                        nombre: m.nombre,
                        idSancionado: m.idSancionado,
                        totalCantidad: Number(m.totalCantidad) || 0,
                        totalSentencia: Number(m.totalSentencia) || 0,
                        articulos: Array.isArray(m.articulos) ? [...m.articulos] : []
                    };
                } else {
                    grupos[key].totalCantidad += Number(m.totalCantidad) || 0;
                    grupos[key].totalSentencia += Number(m.totalSentencia) || 0;
                    // unir art√≠culos (no eliminamos duplicados aqu√≠, puedes hacerlo si quieres)
                    if (Array.isArray(m.articulos)) grupos[key].articulos.push(...m.articulos);
                }
            });
        
            return Object.values(grupos);
        }

        // 2) Render para una tarjeta de multa ‚Äî reutilizable tanto en render como en filtro
        function renderMultaCard(caso) {
            return `
                <div class="case-card">
                    <div class="case-header">
                        <span class="case-number">${caso.number}</span>
                        <span class="case-type multa">MULTA</span>
                    </div>
                
                    <h3 style="color: #f06292; margin: 10px 0;">${caso.title}</h3>
                
                    <p style="color: #ddd;"><strong>ID Sancionado:</strong> ${caso.idSancionado}</p>
                    <p style="color: #ddd;"><strong>Fecha:</strong> ${caso.date}</p>
                
                    <div style="background: rgba(33, 150, 243, 0.1); padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong style="color: #2196f3;">Total:</strong> 
                        <span style="color: #4caf50; font-size: 1.2em;">${(caso.totalCantidad || 0).toLocaleString('es-ES')}</span>
                        <span style="color: #ddd; margin-left: 15px;">Sentencia: ${caso.totalSentencia || 0} meses</span>
                    </div>
                
                    <div style="margin-top: 10px;">
                        <strong style="color: #90caf9;">Art√≠culos:</strong>
                        ${ (caso.articulos && caso.articulos.length) ? caso.articulos.map(a => {
                            // soporte flexible: si el art√≠culo tiene 'codigo' o 'articulo' como etiqueta
                            const codigo = a.codigo ?? a.articulo ?? '';
                            const descripcion = a.descripcion ?? a.descripcionArticulo ?? a.text ?? '';
                            return `<div style="color: #ccc; font-size: 0.9em; padding-left: 15px;">‚Ä¢ ${codigo} ${descripcion}</div>`;
                        }).join('') : '<div style="color:#777; padding-left:15px; font-size:0.9em;">‚Äî Sin art√≠culos ‚Äî</div>'}
                    </div>
                </div>
            `;
        }

        function renderInformeCard(caso) {
            return `
                <div class="case-card">
                    <div class="case-header">
                        <span class="case-number">${caso.number}</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="case-type informe">INFORME</span>
                            <span class="status ${caso.status}">${getStatusText(caso.status)}</span>
                        </div>
                    </div>
                    <h3 style="color: #64b5f6; margin: 10px 0;">${caso.title}</h3>
                    <p style="color: #ddd;"><strong>Detective:</strong> ${caso.detective}</p>
                    <p style="color: #ddd;"><strong>Fecha:</strong> ${caso.date}</p>
                    <p style="color: #ddd; margin-top: 10px;">${caso.summary || ''}</p>
                    ${caso.suspect && caso.suspect.name ? `<p style="color: #90caf9; margin-top: 10px;"><strong>Sospechoso:</strong> ${caso.suspect.name}</p>` : ''}
                </div>
            `;
        }




        function renderHistorial() {
    const container = document.getElementById('historialList');
    if (!container) return;

    const multasAgrupadas = agruparMultas(multas);

    const allCases = [
        ...reports.map(r => ({ ...r, type: 'informe' })),
        ...multasAgrupadas
    ];

    if (allCases.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px; font-style: italic;">No hay casos registrados</p>';
        return;
    }

    allCases.sort((a, b) => (b.id || 0) - (a.id || 0));

    container.innerHTML = allCases.map(caso => {
        if (caso.type === 'informe') return renderInformeCard(caso);
        else return renderMultaCard(caso);
    }).join('');
}




        function filterHistorial() {
    const searchTerm = document.getElementById('searchHistorial').value.toLowerCase();

    const multasAgrupadas = agruparMultas(multas);

    const allCases = [
        ...reports.map(r => ({ ...r, type: 'informe' })),
        ...multasAgrupadas
    ];

    const filtered = allCases.filter(caso => {
        if (caso.type === 'informe') {
            return (caso.number && caso.number.toLowerCase().includes(searchTerm)) ||
                   (caso.title && caso.title.toLowerCase().includes(searchTerm)) ||
                   (caso.detective && caso.detective.toLowerCase().includes(searchTerm)) ||
                   (caso.suspect && caso.suspect.name && caso.suspect.name.toLowerCase().includes(searchTerm));
        } else {
            return (caso.number && caso.number.toLowerCase().includes(searchTerm)) ||
                   (caso.nombre && caso.nombre.toLowerCase().includes(searchTerm)) ||
                   (caso.idSancionado && String(caso.idSancionado).toLowerCase().includes(searchTerm));
        }
    });

    const container = document.getElementById('historialList');
    if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px; font-style: italic;">No se encontraron casos</p>';
        return;
    }

    filtered.sort((a, b) => (b.id || 0) - (a.id || 0));

    container.innerHTML = filtered.map(caso => {
        if (caso.type === 'informe') return renderInformeCard(caso);
        else return renderMultaCard(caso);
    }).join('');
}



        function updateStats() {
            const cerrados = reports.filter(r => r.status === 'cerrado').length;
            const abiertos = reports.filter(r => r.status === 'abierto').length;
            const investigando = reports.filter(r => r.status === 'investigando').length;
            
            document.getElementById('statCasosCerrados').textContent = cerrados;
            document.getElementById('statCasosAbiertos').textContent = abiertos;
            document.getElementById('statCasosInvestigando').textContent = investigando;
            document.getElementById('statMultas').textContent = multas.length;
        }

        function downloadAllData() {
            const allData = {
                reports: reports,
                multas: multas,
                articles: articles,
                categories: categories,
                ranks: ranks
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", "sistema_detectives_completo_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(dlAnchor);
            dlAnchor.click();
            document.body.removeChild(dlAnchor);
            alert('‚úÖ Datos descargados correctamente');
        }

        function loadAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (loadedData.reports) reports = loadedData.reports;
                    if (loadedData.multas) multas = loadedData.multas;
                    if (loadedData.articles) articles = loadedData.articles;
                    if (loadedData.categories) categories = loadedData.categories;
                    if (loadedData.ranks) ranks = loadedData.ranks;

                    renderReports();
                    renderHistorial();
                    updateStats();
                    renderTable(articles);
                    renderCategories();
                    updateCategoryDropdowns();
                    renderHistorialMultas();
                    renderRanks();
                    alert('‚úÖ Datos cargados correctamente');
                } catch (error) {
                    alert('‚ùå Error al cargar el archivo JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==================== FUNCIONES DE LA TABLET ====================
        
        // Funci√≥n mejorada para extraer n√∫meros de las categor√≠as
        function extractCategoryNumber(category) {
            if (!category) return 999999;
            const match = category.match(/^(\d+)\./);
            return match ? parseInt(match[1]) : 999999;
        }

        // Funci√≥n mejorada para extraer n√∫meros de los art√≠culos
        function extractArticleNumber(articulo) {
            if (!articulo) return [999999, 999999];
            const str = articulo.toString();
            const parts = str.split('.');
            const major = parseInt(parts[0]) || 999999;
            const minor = parts[1] ? parseInt(parts[1]) : 0;
            return [major, minor];
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const categoryName = input.value.trim();
            
            if (!categoryName) {
                alert('Por favor, escribe un nombre para la categor√≠a');
                return;
            }
            
            if (categories.includes(categoryName)) {
                alert('Esta categor√≠a ya existe');
                return;
            }
            
            categories.push(categoryName);
            input.value = '';
            renderCategories();
            updateCategoryDropdowns();
        }

async function saveEditedArticle() {
    if (!currentEditingArticle) {
        alert('Error: No hay art√≠culo para guardar');
        return;
    }

    const { doc, updateDoc } = window.firestoreModules;

    const articulo = document.getElementById('editArticuloInput').value;
    const descripcion = document.getElementById('editDescripcionInput').value;
    const cantidad = document.getElementById('editCantidadInput').value;
    const sentencia = document.getElementById('editSentenciaInput').value;

    if (!articulo || !descripcion || !cantidad || !sentencia) {
        alert('Por favor, completa todos los campos obligatorios (*)');
        return;
    }

    try {
        const updatedData = {
            capitulo: document.getElementById('editCapituloInput').value,
            articulo: articulo,
            descripcion: descripcion,
            cantidad: cantidad,
            sentencia: sentencia
        };

        await updateDoc(doc(window.db, 'articles', currentEditingArticle.firestoreId), updatedData);

        Object.assign(currentEditingArticle, updatedData);

        closeEditModal();
        renderTable(articles);
        alert('‚úÖ Art√≠culo actualizado correctamente');
    } catch (error) {
        console.error('Error actualizando art√≠culo:', error);
        alert('‚ùå Error al actualizar el art√≠culo');
    }
}

async function confirmarMulta() {
    const nombre = document.getElementById('nombreMultado').value.trim();
    const idSancionado = document.getElementById('idMultado').value.trim();

    if (!nombre) {
        alert('Por favor, escribe el nombre del sancionado.');
        return;
    }
    if (!idSancionado) {
        alert('Por favor, escribe el ID del sancionado.');
        return;
    }
    if (multaActual.length === 0) {
        alert('No hay art√≠culos a√±adidos a la multa.');
        return;
    }

    const totalCantidad = multaActual.reduce((s, a) => s + parseFloat(a.cantidad || 0), 0);
    const totalSentencia = multaActual.reduce((s, a) => s + parseInt(a.sentencia || 0), 0);

    const nuevaMulta = {
        id: Date.now(),
        nombre: nombre,
        idSancionado: idSancionado,
        articulos: multaActual.map(a => ({
            articulo: a.articulo,
            descripcion: a.descripcion,
            cantidad: parseFloat(a.cantidad || 0),
            sentencia: parseInt(a.sentencia || 0)
        })),
        totalCantidad: totalCantidad,
        totalSentencia: totalSentencia,
        fecha: new Date().toISOString()
    };

    try {
        await firebase.firestore()
            .collection("multas")
            .add(nuevaMulta);

        alert("Multa registrada correctamente.");
        limpiarMultaActual();

    } catch (err) {
        console.error("Error al guardar multa:", err);
        alert("Hubo un error guardando la multa.");
    }
}



async function deleteCategory(categoryName) {
    if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?\n\nLos art√≠culos de esta categor√≠a NO se eliminar√°n.`)) return;
    
    const { collection, getDocs, doc, deleteDoc } = window.firestoreModules;
    
    try {
        const categoriesRef = collection(window.db, 'categories');
        const snapshot = await getDocs(categoriesRef);
        
        snapshot.forEach(async (docSnap) => {
            if (docSnap.data().name === categoryName) {
                await deleteDoc(doc(window.db, 'categories', docSnap.id));
            }
        });
        
        categories = categories.filter(c => c !== categoryName);
        renderCategories();
        updateCategoryDropdowns();
        alert('‚úÖ Categor√≠a eliminada');
    } catch (error) {
        console.error('Error eliminando categor√≠a:', error);
        alert('‚ùå Error al eliminar la categor√≠a');
    }
}

        function renderCategories() {
            const list = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 40px; font-style: italic;">No hay categor√≠as. A√±ade la primera.</p>';
                return;
            }
            
            list.innerHTML = categories.map(cat => `
                <div style="background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                    <span style="color: #fff; font-size: 15px; font-weight: 600;">${cat}</span>
                    <button onclick="deleteCategory('${cat.replace(/'/g, "\\'")}'); event.stopPropagation();" style="background: rgba(220, 60, 60, 0.8); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(220, 60, 60, 1)'" onmouseout="this.style.background='rgba(220, 60, 60, 0.8)'">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            `).join('');
        }

        function addRank() {
            const nameInput = document.getElementById('newRankName');
            const salaryInput = document.getElementById('newRankSalary');
            
            const rankName = nameInput.value.trim();
            const rankSalary = parseFloat(salaryInput.value);
            
            if (!rankName) {
                alert('Por favor, escribe un nombre para el rango');
                return;
            }
            
            if (isNaN(rankSalary) || rankSalary < 0) {
                alert('Por favor, ingresa un salario v√°lido');
                return;
            }
            
            if (ranks.find(r => r.name === rankName)) {
                alert('Este rango ya existe');
                return;
            }
            
            ranks.push({
                id: Date.now(),
                name: rankName,
                salary: rankSalary
            });
            
            nameInput.value = '';
            salaryInput.value = '';
            renderRanks();
        }

        function deleteRank(id) {
            if (confirm('¬øEst√°s seguro de eliminar este rango?')) {
                ranks = ranks.filter(r => r.id !== id);
                renderRanks();
            }
        }

        function renderRanks() {
            const list = document.getElementById('ranksList');
            
            if (ranks.length === 0) {
                list.innerHTML = '<p class="no-data">No hay rangos a√±adidos. A√±ade el primero.</p>';
                return;
            }
            
            list.innerHTML = ranks.map(rank => `
                <div class="rank-card">
                    <div class="rank-info">
                        <div class="rank-name">${rank.name}</div>
                        <div class="rank-salary">${rank.salary.toLocaleString('es-ES')}</div>
                    </div>
                    <div class="rank-actions">
                        <button class="eliminate-btn" onclick="deleteRank(${rank.id})">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateCategoryDropdowns() {
            const addSelect = document.getElementById('capitulo');
            const addCurrentValue = addSelect.value;
            addSelect.innerHTML = '<option value="" disabled selected style="background: #1a1f2e;">Selecciona una categor√≠a...</option>' +
                categories.map(cat => `<option value="${cat}" style="background: #1a1f2e;">${cat}</option>`).join('');
            if (addCurrentValue && categories.includes(addCurrentValue)) {
                addSelect.value = addCurrentValue;
            }
            
            const editSelect = document.getElementById('editCapituloInput');
            const editCurrentValue = editSelect.value;
            editSelect.innerHTML = '<option value="" disabled style="background: #1a1f2e;">Selecciona una categor√≠a...</option>' +
                categories.map(cat => `<option value="${cat}" style="background: #1a1f2e;">${cat}</option>`).join('');
            if (editCurrentValue && categories.includes(editCurrentValue)) {
                editSelect.value = editCurrentValue;
            }
        }

        function openTab(tabId, tabName) {
            closeModal();
            
            const existingTab = openTabs.find(t => t.id === tabId);
            if (existingTab) {
                activateTab(tabId);
                return;
            }

            openTabs.push({ id: tabId, name: tabName });
            renderTabs();
            activateTab(tabId);
            
            if (tabId === 'a√±adir' || tabId === 'categorias') {
                setTimeout(updateCategoryDropdowns, 100);
            }
        }

        function activateTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            const tabBtn = document.querySelector(`[data-tab="${tabId}"]`);
            if (tabBtn) tabBtn.classList.add('active');
            
            const tabPanel = document.getElementById(tabId);
            if (tabPanel) tabPanel.classList.add('active');
        }

        function closeTab(tabId, event) {
            event.stopPropagation();
            
            openTabs = openTabs.filter(t => t.id !== tabId);
            
            const tabPanel = document.getElementById(tabId);
            if (tabPanel) tabPanel.classList.remove('active');
            
            if (openTabs.length === 0) {
                document.getElementById('home').classList.add('active');
            } else {
                activateTab(openTabs[openTabs.length - 1].id);
            }
            
            renderTabs();
        }

        function renderTabs() {
            const header = document.getElementById('tabletHeader');
            const addBtn = document.getElementById('addTabBtn');
            
            header.innerHTML = '';
            header.appendChild(addBtn);
            
            openTabs.forEach(tab => {
                const tabBtn = document.createElement('div');
                tabBtn.className = 'tab-button';
                tabBtn.setAttribute('data-tab', tab.id);
                tabBtn.innerHTML = `
                    ${tab.name} 
                    <span class="close-icon" onclick="closeTab('${tab.id}', event)">√ó</span>
                `;
                
                tabBtn.addEventListener('click', () => activateTab(tab.id));
                header.insertBefore(tabBtn, addBtn);
            });
        }

        async function addArticle(event) {
            event.preventDefault();

            const { collection, addDoc } = window.firestoreModules;

            const article = {
                id: Date.now(),
                capitulo: document.getElementById('capitulo').value,
                articulo: document.getElementById('articulo').value,
                descripcion: document.getElementById('descripcion').value,
                cantidad: document.getElementById('cantidad').value,
                sentencia: document.getElementById('sentencia').value
            };
        
            if (!article.capitulo || !article.articulo || !article.descripcion || !article.cantidad || !article.sentencia) {
                alert('Por favor, completa todos los campos obligatorios (*)');
                return;
            }
        
            try {
                const docRef = await addDoc(collection(window.db, 'articles'), article);
                articles.push({ ...article, firestoreId: docRef.id });

                document.getElementById('addCodeForm').reset();
                alert('‚úî Art√≠culo a√±adido correctamente');

                renderTable(articles);
            } catch (error) {
                console.error('Error a√±adiendo art√≠culo:', error);
                alert('‚ùå Error al a√±adir el art√≠culo');
            }
        }

        async function deleteArticle(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este art√≠culo?')) return;

            const { doc, deleteDoc } = window.firestoreModules;

            try {
                const article = articles.find(a => a.id == id);
                if (!article) return;

                await deleteDoc(doc(window.db, 'articles', article.firestoreId));
                articles = articles.filter(a => a.id !== id);
                renderTable(articles);
                alert('‚úÖ Art√≠culo eliminado');
            } catch (error) {
                console.error('Error eliminando art√≠culo:', error);
                alert('‚ùå Error al eliminar el art√≠culo');
            }
        }

        function editArticle(id) {
            const article = articles.find(a => a.id == id);
            if (!article) {
                alert('Error: Art√≠culo no encontrado');
                return;
            }
        
            currentEditingArticle = article;
        
            updateCategoryDropdowns();
        
            setTimeout(() => {
                document.getElementById('editCapituloInput').value = article.capitulo || '';
                document.getElementById('editArticuloInput').value = article.articulo;
                document.getElementById('editDescripcionInput').value = article.descripcion;
                document.getElementById('editCantidadInput').value = article.cantidad;
                document.getElementById('editSentenciaInput').value = article.sentencia;
            
                document.getElementById('editModal').classList.add('active');

                setTimeout(() => {
                    document.getElementById('editArticuloInput').focus();
                }, 100);
            }, 50);
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingArticle = null;
        }

        async function saveEditedArticle() {
            if (!currentEditingArticle) {
                alert('Error: No hay art√≠culo para guardar');
                return;
            }
        
            const { doc, updateDoc } = window.firestoreModules;
        
            const articulo = document.getElementById('editArticuloInput').value;
            const descripcion = document.getElementById('editDescripcionInput').value;
            const cantidad = document.getElementById('editCantidadInput').value;
            const sentencia = document.getElementById('editSentenciaInput').value;
        
            if (!articulo || !descripcion || !cantidad || !sentencia) {
                alert('Por favor, completa todos los campos obligatorios (*)');
                return;
            }
        
            try {
                const updatedData = {
                    capitulo: document.getElementById('editCapituloInput').value,
                    articulo: articulo,
                    descripcion: descripcion,
                    cantidad: cantidad,
                    sentencia: sentencia
                };
            
                await updateDoc(doc(window.db, 'articles', currentEditingArticle.firestoreId), updatedData);
            
                Object.assign(currentEditingArticle, updatedData);
            
                closeEditModal();
                renderTable(articles);
                alert('‚úÖ Art√≠culo actualizado correctamente');
            } catch (error) {
                console.error('Error actualizando art√≠culo:', error);
                alert('‚ùå Error al actualizar el art√≠culo');
            }
        }
        
async function saveEditedArticle() {
    if (!currentEditingArticle) {
        alert('Error: No hay art√≠culo para guardar');
        return;
    }

    const { doc, updateDoc } = window.firestoreModules;

    const articulo = document.getElementById('editArticuloInput').value;
    const descripcion = document.getElementById('editDescripcionInput').value;
    const cantidad = document.getElementById('editCantidadInput').value;
    const sentencia = document.getElementById('editSentenciaInput').value;

    if (!articulo || !descripcion || !cantidad || !sentencia) {
        alert('Por favor, completa todos los campos obligatorios (*)');
        return;
    }

    try {
        const updatedData = {
            capitulo: document.getElementById('editCapituloInput').value,
            articulo: articulo,
            descripcion: descripcion,
            cantidad: cantidad,
            sentencia: sentencia
        };

        await updateDoc(doc(window.db, 'articles', currentEditingArticle.firestoreId), updatedData);

        Object.assign(currentEditingArticle, updatedData);

        closeEditModal();
        renderTable(articles);
        alert('‚úÖ Art√≠culo actualizado correctamente');
    } catch (error) {
        console.error('Error actualizando art√≠culo:', error);
        alert('‚ùå Error al actualizar el art√≠culo');
    }
}

async function addCategory() {
    const { collection, addDoc } = window.firestoreModules;
    
    const input = document.getElementById('newCategoryInput');
    const categoryName = input.value.trim();
    
    if (!categoryName) {
        alert('Por favor, escribe un nombre para la categor√≠a');
        return;
    }
    
    if (categories.includes(categoryName)) {
        alert('Esta categor√≠a ya existe');
        return;
    }
    
    try {
        await addDoc(collection(window.db, 'categories'), { name: categoryName });
        categories.push(categoryName);
        input.value = '';
        renderCategories();
        updateCategoryDropdowns();
        alert('‚úÖ Categor√≠a a√±adida');
    } catch (error) {
        console.error('Error a√±adiendo categor√≠a:', error);
        alert('‚ùå Error al a√±adir la categor√≠a');
    }
}

async function deleteCategory(categoryName) {
    if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?\n\nLos art√≠culos de esta categor√≠a NO se eliminar√°n.`)) return;
    
    const { collection, getDocs, doc, deleteDoc } = window.firestoreModules;
    
    try {
        const categoriesRef = collection(window.db, 'categories');
        const snapshot = await getDocs(categoriesRef);
        
        snapshot.forEach(async (docSnap) => {
            if (docSnap.data().name === categoryName) {
                await deleteDoc(doc(window.db, 'categories', docSnap.id));
            }
        });
        
        categories = categories.filter(c => c !== categoryName);
        renderCategories();
        updateCategoryDropdowns();
        alert('‚úÖ Categor√≠a eliminada');
    } catch (error) {
        console.error('Error eliminando categor√≠a:', error);
        alert('‚ùå Error al eliminar la categor√≠a');
    }
}
        
async function saveEditedArticle() {
    if (!currentEditingArticle) {
        alert('Error: No hay art√≠culo para guardar');
        return;
    }

    const { doc, updateDoc } = window.firestoreModules;

    const articulo = document.getElementById('editArticuloInput').value;
    const descripcion = document.getElementById('editDescripcionInput').value;
    const cantidad = document.getElementById('editCantidadInput').value;
    const sentencia = document.getElementById('editSentenciaInput').value;

    if (!articulo || !descripcion || !cantidad || !sentencia) {
        alert('Por favor, completa todos los campos obligatorios (*)');
        return;
    }

    try {
        const updatedData = {
            capitulo: document.getElementById('editCapituloInput').value,
            articulo: articulo,
            descripcion: descripcion,
            cantidad: cantidad,
            sentencia: sentencia
        };

        await updateDoc(doc(window.db, 'articles', currentEditingArticle.firestoreId), updatedData);

        Object.assign(currentEditingArticle, updatedData);

        closeEditModal();
        renderTable(articles);
        alert('‚úÖ Art√≠culo actualizado correctamente');
    } catch (error) {
        console.error('Error actualizando art√≠culo:', error);
        alert('‚ùå Error al actualizar el art√≠culo');
    }
}

async function addCategory() {
    const { collection, addDoc } = window.firestoreModules;
    
    const input = document.getElementById('newCategoryInput');
    const categoryName = input.value.trim();
    
    if (!categoryName) {
        alert('Por favor, escribe un nombre para la categor√≠a');
        return;
    }
    
    if (categories.includes(categoryName)) {
        alert('Esta categor√≠a ya existe');
        return;
    }
    
    try {
        await addDoc(collection(window.db, 'categories'), { name: categoryName });
        categories.push(categoryName);
        input.value = '';
        renderCategories();
        updateCategoryDropdowns();
        alert('‚úÖ Categor√≠a a√±adida');
    } catch (error) {
        console.error('Error a√±adiendo categor√≠a:', error);
        alert('‚ùå Error al a√±adir la categor√≠a');
    }
}

async function deleteCategory(categoryName) {
    if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?\n\nLos art√≠culos de esta categor√≠a NO se eliminar√°n.`)) return;
    
    const { collection, getDocs, doc, deleteDoc } = window.firestoreModules;
    
    try {
        const categoriesRef = collection(window.db, 'categories');
        const snapshot = await getDocs(categoriesRef);
        
        snapshot.forEach(async (docSnap) => {
            if (docSnap.data().name === categoryName) {
                await deleteDoc(doc(window.db, 'categories', docSnap.id));
            }
        });
        
        categories = categories.filter(c => c !== categoryName);
        renderCategories();
        updateCategoryDropdowns();
        alert('‚úÖ Categor√≠a eliminada');
    } catch (error) {
        console.error('Error eliminando categor√≠a:', error);
        alert('‚ùå Error al eliminar la categor√≠a');
    }
}

        function moveArticle(id, direction) {
            const index = articles.findIndex(a => a.id === id);
            if (index === -1) return;

            if (direction === 'up' && index > 0) {
                [articles[index], articles[index - 1]] = [articles[index - 1], articles[index]];
            } else if (direction === 'down' && index < articles.length - 1) {
                [articles[index], articles[index + 1]] = [articles[index + 1], articles[index]];
            }

            renderTable(articles);
        }

        function editChapter(currentChapter) {
            const newChapter = prompt('Editar nombre del cap√≠tulo:', currentChapter);
            if (newChapter === null || newChapter === currentChapter) return;

            articles = articles.map(a => {
                if (a.capitulo === currentChapter) {
                    return { ...a, capitulo: newChapter };
                }
                return a;
            });

            renderTable(articles);
        }

        function renderTable(data, searchTerm = '') {
            const tbody = document.getElementById('codeTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No hay art√≠culos registrados. Ve a "A√ëADIR C√ìDIGO" para comenzar.</td></tr>';
                return;
            }

            // Ordenamiento mejorado
            data.sort((a, b) => {
                const catNumA = extractCategoryNumber(a.capitulo);
                const catNumB = extractCategoryNumber(b.capitulo);
                
                if (catNumA !== catNumB) {
                    return catNumA - catNumB;
                }
                
                const [majorA, minorA] = extractArticleNumber(a.articulo);
                const [majorB, minorB] = extractArticleNumber(b.articulo);
                
                if (majorA !== majorB) {
                    return majorA - majorB;
                }
                
                return minorA - minorB;
            });

            let html = '';
            let lastChapter = '';

            data.forEach((article, index) => {
                if (article.capitulo && article.capitulo !== lastChapter) {
                    html += `
                        <tr class="section-header-row">
                            <td colspan="5" class="section-header">
                                ${article.capitulo}
                                ${userRole === 'full' ? `
                                    <button class="edit-chapter-btn admin-only" onclick="editChapter('${article.capitulo.replace(/'/g, "\\'")}')">
                                        ‚úèÔ∏è Editar
                                    </button>
                                ` : ''}
                            </td>
                        </tr>`;
                    lastChapter = article.capitulo;
                }

                const isFirst = index === 0;
                const isLast = index === data.length - 1;

                html += `
                    <tr>
                        <td class="article-number">${article.articulo}</td>
                        <td>${article.descripcion}</td>
                        <td>${parseInt(article.cantidad).toLocaleString('es-ES')}</td>
                        <td>${article.sentencia} MESES</td>
                        <td>
                            ${userRole === 'full' ? `
                                <div class="action-btns-group">
                                    <button class="move-btn admin-only" onclick="moveArticle(${article.id}, 'up')" ${isFirst ? 'disabled' : ''}>‚Üë</button>
                                    <button class="move-btn admin-only" onclick="moveArticle(${article.id}, 'down')" ${isLast ? 'disabled' : ''}>‚Üì</button>
                                    <button class="edit-btn admin-only" onclick="editArticle(${article.id})">EDITAR</button>
                                    <button class="eliminate-btn admin-only" onclick="deleteArticle(${article.id})">ELIMINAR</button>
                                </div>
                            ` : '<span style="color:#999; font-style:italic; font-size:12px;">Solo lectura</span>'}
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function searchInCode() {
            const searchTerm = document.getElementById('searchCode').value.toLowerCase();
            
            if (!searchTerm) {
                renderTable(articles);
                return;
            }

            const filtered = articles.filter(a =>
                a.articulo.toString().toLowerCase().includes(searchTerm) ||
                (a.descripcion && a.descripcion.toLowerCase().includes(searchTerm)) ||
                (a.capitulo && a.capitulo.toLowerCase().includes(searchTerm))
            );

            renderTable(filtered, searchTerm);
        }

        function mostrarArticulosMulta() {
            const tbody = document.getElementById('articulosMultaBody');
            const buscar = document.getElementById('buscarArticulo').value.trim().toLowerCase();

            const filtrados = articles.filter(a =>
                a.articulo.toString().toLowerCase().includes(buscar) ||
                (a.descripcion && a.descripcion.toString().toLowerCase().includes(buscar)) ||
                (a.capitulo && a.capitulo.toString().toLowerCase().includes(buscar))
            );

            if (filtrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No se encontraron art√≠culos.</td></tr>';
                return;
            }

            tbody.innerHTML = filtrados.map(a => `
                <tr>
                    <td>${a.articulo}</td>
                    <td>${a.descripcion}</td>
                    <td>${parseFloat(a.cantidad).toLocaleString('es-ES')}</td>
                    <td>${a.sentencia} meses</td>
                    <td><button class="edit-btn" onclick="agregarArticuloMulta(${a.id})">‚ûï Agregar</button></td>
                </tr>
            `).join('');
        }

        function agregarArticuloMulta(id) {
            const art = articles.find(a => a.id === id);
            if (!art) return;
            multaActual.push(Object.assign({}, art));
            renderMultaActual();
        }

        function eliminarArticuloMulta(index) {
            multaActual.splice(index, 1);
            renderMultaActual();
        }

        function limpiarMultaActual() {
            if (confirm('¬øLimpiar la multa actual?')) {
                multaActual = [];
                renderMultaActual();
            }
        }

        function renderMultaActual() {
            const tbody = document.getElementById('multaActualBody');
            if (multaActual.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No hay art√≠culos en la multa actual.</td></tr>';
                document.getElementById('totalCantidad').textContent = '0';
                document.getElementById('totalSentencia').textContent = '0';
            } else {
                let html = '';
                let totalCantidad = 0;
                let totalSentencia = 0;
                multaActual.forEach((a, i) => {
                    totalCantidad += parseFloat(a.cantidad || 0);
                    totalSentencia += parseInt(a.sentencia || 0);
                    html += `
                        <tr>
                            <td class="article-number">${a.articulo}</td>
                            <td>${a.descripcion}</td>
                            <td>${parseFloat(a.cantidad).toLocaleString('es-ES')}</td>
                            <td>${a.sentencia} meses</td>
                            <td><button class="eliminate-btn" onclick="eliminarArticuloMulta(${i})">üóëÔ∏è</button></td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
                document.getElementById('totalCantidad').textContent = totalCantidad.toLocaleString('es-ES');
                document.getElementById('totalSentencia').textContent = totalSentencia;
            }
        }

async function confirmarMulta() {
    const nombre = document.getElementById('nombreMultado').value.trim();
    const idSancionado = document.getElementById('idMultado').value.trim();

    if (!nombre) {
        alert('Por favor, escribe el nombre del sancionado.');
        return;
    }
    if (!idSancionado) {
        alert('Por favor, escribe el ID del sancionado.');
        return;
    }
    if (multaActual.length === 0) {
        alert('No hay art√≠culos a√±adidos a la multa.');
        return;
    }

    const totalCantidad = multaActual.reduce((s, a) => s + parseFloat(a.cantidad || 0), 0);
    const totalSentencia = multaActual.reduce((s, a) => s + parseInt(a.sentencia || 0), 0);

    const nuevaMulta = {
        id: Date.now(),
        nombre: nombre,
        idSancionado: idSancionado,
        articulos: multaActual.map(a => ({
            articulo: a.articulo,
            descripcion: a.descripcion,
            cantidad: parseFloat(a.cantidad || 0),
            sentencia: parseInt(a.sentencia || 0)
        })),
        totalCantidad: totalCantidad,
        totalSentencia: totalSentencia,
        fecha: new Date().toISOString()
    };

    try {
        await firebase.firestore()
            .collection("multas")
            .add(nuevaMulta);

        alert("Multa registrada correctamente.");
        limpiarMultaActual();

    } catch (err) {
        console.error("Error al guardar multa:", err);
        alert("Hubo un error guardando la multa.");
    }
}


        function renderHistorialMultas() {
            const container = document.getElementById('historialMultas');
            if (!container) return;
            if (multas.length === 0) {
                container.innerHTML = '<p class="no-data" style="color:#999;">No hay multas guardadas.</p>';
                return;
            }
            container.innerHTML = multas.map(m => `
                <div style="background: rgba(255, 255, 255, 0.05); padding:10px; border-radius:8px; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="color:#fff;">${m.nombre}</strong>
                            <span style="color:#a78bfa; font-weight:600; margin-left:8px;">ID: ${m.idSancionado || 'N/A'}</span>
                        </div>
                        <span style="color:#ddd; font-size:12px;">${new Date(m.fecha).toLocaleString()}</span>
                    </div>
                    <div style="color:#ddd; font-size:13px; margin-top:6px;">
                        <em>Total:</em> ${m.totalCantidad.toLocaleString('es-ES')} $ ‚Äî ${m.totalSentencia} meses
                    </div>
                    <div style="margin-top:8px;">
                        ${m.articulos.map(a => `<div style="color:#ccc; font-size:13px;">‚Ä¢ ${a.articulo} ‚Äî ${a.descripcion} (${a.cantidad}$, ${a.sentencia} meses)</div>`).join('')}
                    </div>
                    <div style="margin-top:8px; display:flex; gap:8px;">
                        <button class="edit-btn" onclick="exportarMulta(${m.id})">üìÑ Exportar</button>
                        <button class="eliminate-btn" onclick="borrarMulta(${m.id})">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function exportarMulta(id) {
            const multa = multas.find(m => m.id === id);
            if (!multa) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(multa, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `multa_${multa.nombre.replace(/\s+/g,'_')}_${multa.id}.json`);
            dlAnchor.click();
        }

        function borrarMulta(id) {
            if (!confirm('¬øEliminar esta multa del historial?')) return;
            multas = multas.filter(m => m.id !== id);
            renderHistorialMultas();
            updateStats();
        }

        function downloadJSON() {
            const dataToExport = {
                categories: categories || [],
                articles: articles || [],
                multas: multas || [],
                ranks: ranks || []
            };

            if (dataToExport.categories.length === 0 && dataToExport.articles.length === 0 && dataToExport.multas.length === 0 && dataToExport.ranks.length === 0) {
                alert('No hay datos para descargar.');
                return;
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", "codigo_criminal.json");
            document.body.appendChild(dlAnchor);
            dlAnchor.click();
            document.body.removeChild(dlAnchor);
            alert('‚úì JSON descargado correctamente\n\n' + dataToExport.categories.length + ' categor√≠as\n' + dataToExport.articles.length + ' art√≠culos\n' + dataToExport.multas.length + ' multas\n' + dataToExport.ranks.length + ' rangos');
        }

        function loadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);

                    let loadedCategories = [];
                    let loadedArticles = [];
                    let loadedMultas = [];
                    let loadedRanks = [];

                    if (Array.isArray(loadedData)) {
                        loadedArticles = loadedData;
                    } else if (loadedData.articles || loadedData.categories || loadedData.multas || loadedData.ranks) {
                        loadedCategories = loadedData.categories || [];
                        loadedArticles = loadedData.articles || [];
                        loadedMultas = loadedData.multas || [];
                        loadedRanks = loadedData.ranks || [];
                    } else if (loadedData.codigo_criminal) {
                        const cc = loadedData.codigo_criminal;
                        if (Array.isArray(cc)) {
                            cc.forEach(ch => {
                                if (ch.articulos && Array.isArray(ch.articulos)) {
                                    ch.articulos.forEach(a => {
                                        loadedArticles.push(Object.assign({}, a, { capitulo: ch.capitulo || '' }));
                                    });
                                }
                            });
                        }
                        loadedMultas = loadedData.multas || [];
                        loadedRanks = loadedData.ranks || [];
                    } else {
                        throw new Error('Formato de archivo no reconocido');
                    }

                    const confirmLoad = confirm(
                        `Se cargar√°n:\n- ${loadedCategories.length} categor√≠as\n- ${loadedArticles.length} art√≠culos\n- ${loadedMultas.length} multas\n- ${loadedRanks.length} rangos\n\nOK = REEMPLAZAR | Cancelar = AGREGAR`
                    );

                    if (confirmLoad) {
                        categories = loadedCategories.slice();
                        articles = loadedArticles.map((a, idx) => Object.assign({}, a, { id: Date.now() + idx }));
                        multas = loadedMultas.map((m, idx) => Object.assign({}, m, { id: m.id || Date.now() + idx }));
                        ranks = loadedRanks.map((r, idx) => Object.assign({}, r, { id: r.id || Date.now() + idx }));
                    } else {
                        loadedCategories.forEach(cat => { if (!categories.includes(cat)) categories.push(cat); });
                        const newArticles = loadedArticles.map((a, idx) => Object.assign({}, a, { id: Date.now() + idx + 1000 }));
                        articles = articles.concat(newArticles);
                        const newMultas = loadedMultas.map((m, idx) => Object.assign({}, m, { id: m.id || Date.now() + idx + 2000 }));
                        multas = multas.concat(newMultas);
                        const newRanks = loadedRanks.map((r, idx) => Object.assign({}, r, { id: r.id || Date.now() + idx + 3000 }));
                        ranks = ranks.concat(newRanks);
                    }

                    renderTable(articles);
                    renderCategories();
                    updateCategoryDropdowns();
                    renderHistorialMultas();
                    renderRanks();
                    updateStats();

                    alert(`‚úì JSON cargado correctamente:\n\n${loadedCategories.length} categor√≠as\n${loadedArticles.length} art√≠culos\n${loadedMultas.length} multas\n${loadedRanks.length} rangos`);

                    if (!openTabs.find(t => t.id === 'codigo')) {
                        openTab('codigo', 'C. CRIMINAL');
                    } else {
                        activateTab('codigo');
                    }

                } catch (err) {
                    alert('‚úó Error al cargar el archivo JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Inicializaci√≥n
            document.addEventListener('DOMContentLoaded', function() {
        // Esperar a que Firebase se inicialice antes de cargar datos
        setTimeout(() => {
            loadDataFromFirestore();
        }, 1000);

        // Renderizar elementos locales
        try { renderMultaActual(); } catch(e) {}
        });
        function showSection(sectionId) {
    // Ocultar todas las secciones
    document.querySelectorAll('.section').forEach(sec => {
        sec.classList.remove('active');
    });

    // Mostrar la secci√≥n seleccionada
    const target = document.getElementById(sectionId);
    if (target) target.classList.add('active');

    // Actualizar botones activos de navegaci√≥n
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    const activeBtn = document.querySelector(`button[onclick="showSection('${sectionId}')"]`);
    if (activeBtn) activeBtn.classList.add('active');
}



        /* ===========================
           LOGIN + ROLES + PERMISOS
           =========================== */

        /* HASHES SHA-256 de las contrase√±as (solo hashes, no las contrase√±as en claro) */
        const PASS_LIMITED = "8c98643ca577d8ef2f5c4c0229c9301a223511ae4b089b5abbe8bbd000c93c84";
        const PASS_FULL = "99b57e143b81ec6b426fd04d91ac94a852a842e536cfe11df2fed0099f6eebda";
        const PASS_ABOGADO = "dfa5af41740c3eb039ef966fd24867703a1fd4b86229a1b04eac86f1d61a3ea5";

        /* Estado de sesi√≥n */
        let userRole = "limited"; // "limited" | "full" | null

        /* Helper SHA-256 - usa SubtleCrypto */
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        /* Comprueba contrase√±a cuando el usuario hace click */
        async function checkPassword() {
            const pass = document.getElementById("passwordInput").value || "";
            const hash = await sha256(pass);
        
            if (hash === PASS_LIMITED) {
                userRole = "limited";
                persistRole();
                closeLogin();
            }
            else if (hash === PASS_FULL) {
                userRole = "full";
                persistRole();
                closeLogin();
            }
            else if (hash === PASS_ABOGADO) {
                userRole = "abogado";
                persistRole();
                closeLogin();
            }
            else {
                const err = document.getElementById("loginError");
                err.style.display = "block";
                err.textContent = "Contrase√±a incorrecta";
            }
        }

        /* Funci√≥n helper para pruebas r√°pidas (rellena input) */
        function fillDemo() {
            // Rellena con la contrase√±a limitada por defecto para test r√°pido
            document.getElementById("passwordInput").value = "detectives123";
        }

        /* Cierra pantalla de login y aplica permisos */
        function closeLogin() {
            const loginScreen = document.getElementById("loginScreen");
            if (loginScreen) loginScreen.style.display = "none";
            applyPermissions();
        }

        /* Persistir rol en sessionStorage para mantener sesi√≥n en recarga */
        function persistRole() {
            try {
                sessionStorage.setItem('userRole', userRole);
            } catch (e) {
                console.warn('No se pudo persistir sesi√≥n:', e);
            }
        }

        /* Restaurar sesi√≥n al cargar la p√°gina (si existe) */
        function restoreSessionIfExists() {
            try {
                const r = sessionStorage.getItem('userRole');
                if (r === 'limited' || r === 'full' || r === 'abogado') {
                    userRole = r;
                    const loginScreen = document.getElementById("loginScreen");
                    if (loginScreen) loginScreen.style.display = "none";
                    applyPermissions();
                }
            } catch (e) {
                console.warn('Error restaurando sesi√≥n:', e);
            }
        }

        /* Logout: borrar sesi√≥n y mostrar login otra vez */
        function logout() {
            userRole = null;
            try { sessionStorage.removeItem('userRole'); } catch(e){}
            // mostrar login
            const loginScreen = document.getElementById("loginScreen");
            if (loginScreen) loginScreen.style.display = 'flex';
            // opcional: limpiar input
            const p = document.getElementById("passwordInput");
            if (p) p.value = '';
            // ocultar elementos por seguridad hasta nuevo login
            const all = document.querySelectorAll('.admin-only, .detective-only');
            all.forEach(e => e.style.display = 'none');
        }

        /* ===========================
           applyPermissions ‚Äî Ajustado al requerimiento
           - limited (detectives123): puede ver MULTAS, HISTORIAL DE INFORMES, INFORMES; puede A√ëADIR INFORMES.
           - full (detectivesls2025*): todo (mostrar admin-only, permitir crear y borrar).
           Implementaci√≥n por clases:
             .detective-only   -> visible para limited y full (visibles despu√©s de login)
             .admin-only       -> visible solo para full
             .detective-block  -> visible solo para full (oculto para limited)
           =========================== */
            function applyPermissions() {
                const allDetective = document.querySelectorAll('.detective-only');
                const allAdmin = document.querySelectorAll('.admin-only');
                const allDetectiveBlock = document.querySelectorAll('.detective-block');
                const allAbogado = document.querySelectorAll('.abogado-only');
            
                // Ocultar todo por defecto
                allDetective.forEach(e => e.style.display = 'none');
                allAdmin.forEach(e => e.style.display = 'none');
                allDetectiveBlock.forEach(e => e.style.display = 'none');
                allAbogado.forEach(e => e.style.display = 'none');
            
                if (userRole === 'limited') {
                    // Detective limitado: ver multas, informes, historial
                    allDetective.forEach(e => e.style.display = 'block');

                } else if (userRole === 'full') {
                    // Administrador: ver TODO
                    allDetective.forEach(e => e.style.display = 'block');
                    allAdmin.forEach(e => e.style.display = 'block');
                    allDetectiveBlock.forEach(e => e.style.display = 'block');

                } else if (userRole === 'abogado') {
                    // Abogado: solo historial y c√≥digo criminal (lectura)
                    allAbogado.forEach(e => e.style.display = 'block');
                }
            
                // Desactivar botones seg√∫n rol
                const addMultaBtns = document.querySelectorAll('[data-action="add-multa"]');
                addMultaBtns.forEach(b => { b.disabled = (userRole !== 'full'); });
            
                const addInformeBtns = document.querySelectorAll('[data-action="add-informe"]');
                addInformeBtns.forEach(b => { b.disabled = (userRole === null || userRole === 'abogado'); });
            
                // Mostrar indicador de rol
                const indicator = document.getElementById('userRoleIndicator');
                if (indicator) {
                    indicator.textContent = userRole ? `Rol: ${userRole}` : '';
                }
            }

        /* ===========================
           Wrappers seguros para acciones cr√≠ticas
           - safeAddInforme(data): permite limited y full
           - safeAddMulta(data): permite solo full
           Estos wrappers comprueban el rol y devuelven boolean si se a√±adi√≥.
           Reemplaza tus llamadas directas a addInforme/addMulta por estas.
           =========================== */

        /* Ejemplo de implementaciones m√≠nimas; adapta a tu l√≥gica real (guardar en array, persistir, etc.) */
        function safeAddInforme(informeObj) {
            if (!userRole) { alert('No autorizado. Inicia sesi√≥n.'); return false; }
            // limited y full pueden a√±adir informes
            // aqu√≠ llamas a tu funci√≥n real que a√±ade informes, por ejemplo addInforme(informeObj)
            if (typeof addInforme === 'function') {
                addInforme(informeObj);
            } else {
                // si no existe addInforme, simulamos push en reports si existe la variable global
                if (Array.isArray(window.reports)) window.reports.push(informeObj);
            }
            // despu√©s de a√±adir, refrescamos vista
            if (typeof renderHistorial === 'function') renderHistorial();
            return true;
        }

        function safeAddMulta(multaObj) {
            if (userRole !== 'full') { alert('No tienes permiso para crear multas.'); return false; }
            // solo full puede a√±adir multas
            if (typeof addMulta === 'function') {
                addMulta(multaObj);
            } else {
                if (Array.isArray(window.multas)) window.multas.push(multaObj);
            }
            if (typeof renderHistorial === 'function') renderHistorial();
            return true;
        }

        /* ===========================
           Inicializaci√≥n al cargar la p√°gina
           =========================== */
        document.addEventListener('DOMContentLoaded', function() {
            // Restaurar sesi√≥n si existe
            restoreSessionIfExists();
        
            // Si no hay sesi√≥n, el login permanecer√° visible
            // Si la pantalla de login no existe, aplicamos permisos de todos ocultos
            if (!userRole) {
            // ocultar elementos por defecto hasta el login
                const all = document.querySelectorAll('.admin-only, .detective-only, .detective-block');
                all.forEach(e => e.style.display = 'none');
            }
        
            // Optional: asignar logout si existe bot√≥n con id logoutBtn
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.addEventListener('click', logout);
        });
        function showSection(sectionId) {
    // Ocultar todas las secciones
    document.querySelectorAll('.section').forEach(sec => {
        sec.classList.remove('active');
    });

    // Mostrar la secci√≥n seleccionada
    const target = document.getElementById(sectionId);
    if (target) target.classList.add('active');

    // Actualizar botones activos de navegaci√≥n
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    const activeBtn = document.querySelector(`button[onclick="showSection('${sectionId}')"]`);
    if (activeBtn) activeBtn.classList.add('active');
}

<!-- Cierre de tu √∫ltimo script original -->
        </script>  

        <!-- Firebase sin imports -->
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

        <script>
            const firebaseConfig = {
                apiKey: "...",
                authDomain: "...",
                databaseURL: "...",
                projectId: "...",
                storageBucket: "...",
                messagingSenderId: "...",
                appId: "..."
            };
        
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.firestore();
        </script>
        <!-- FIN FIREBASE -->
</body>
</html>
